<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction of `itsdm` with a virtual species • itsdm</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction of `itsdm` with a virtual species">
<meta property="og:description" content="itsdm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">itsdm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction_of_itsdm.html">Introduction of `itsdm` with a virtual species</a>
    </li>
    <li>
      <a href="../articles/itsdm_example.html">Using `itsdm` to a real species: Africa savanna elephant</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/LLeiSong/itsdm/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction_of_itsdm_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction of <code>itsdm</code> with a virtual species</h1>
                        <h4 data-toc-skip class="author">Lei Song</h4>
            
            <h4 data-toc-skip class="date">2022-01-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/LLeiSong/itsdm/blob/HEAD/vignettes/introduction_of_itsdm.Rmd" class="external-link"><code>vignettes/introduction_of_itsdm.Rmd</code></a></small>
      <div class="hidden name"><code>introduction_of_itsdm.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="set-up">Set up<a class="anchor" aria-label="anchor" href="#set-up"></a>
</h2>
<p>Install your missing packages</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'rnaturalearth'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'here'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'virtualspecies'</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span>, quietly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/LLeiSong/itsdm" class="external-link">itsdm</a></span>, quietly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span>, quietly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, quietly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">select</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-environmental-variables">Prepare environmental variables<a class="anchor" aria-label="anchor" href="#prepare-environmental-variables"></a>
</h2>
<p>We could use packages like <code>rnaturalearth</code> to quickly get the boundary of most countries and regions. You can also read your study area boundary for sure. Providing your boundary to function <code>worldclim2</code> would allow you to download files from worldclim version 2 clipping to your area.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span>, quietly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearth" class="external-link">rnaturalearth</a></span>, quietly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="co"># Get Africa continent</span>
<span class="va">af</span> <span class="op">&lt;-</span> <span class="fu">ne_countries</span><span class="op">(</span>
  continent <span class="op">=</span> <span class="st">'africa'</span>, returnclass <span class="op">=</span> <span class="st">'sf'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">admin</span> <span class="op">!=</span> <span class="st">'Madagascar'</span><span class="op">)</span> <span class="co"># remove Madagascar</span>

<span class="co"># Union countries to continent</span>
<span class="va">af_bry</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">af</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">bios</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/worldclim2.html">worldclim2</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">'bio'</span>, bry <span class="op">=</span> <span class="va">af_bry</span>,
                   path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,
                   nm_mark <span class="op">=</span> <span class="st">'africa'</span><span class="op">)</span>

<span class="co"># Plot BIO1 to check the variables</span>
<span class="co"># plot(bios %&gt;% slice('band', 1),</span>
<span class="co">#      main = st_get_dimension_values(bios, 'band')[1])</span></code></pre></div>
<p>In species modeling, people usually want to remove the strong correlations between environmental variables. <code>dim_reduce</code> is such a function you need. The function could either reduce the dimension of your environmental variable stack itself or according to a bunch of observations. It also allows you to set a desirable threshold. Note that it only works on numeric variables. Because categorical variables have less risk of having a high correlation with others, we usually prefer to keep categorical variables.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span>, quietly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="co"># An example of reducing dimensions</span>
<span class="co">## Here we didn't set samples, so use whole image</span>
<span class="va">bios_reduce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dim_reduce.html">dim_reduce</a></span><span class="op">(</span>
  <span class="va">bios</span>, threshold <span class="op">=</span> <span class="fl">0.6</span>,
  preferred_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'bio1'</span>, <span class="st">'bio12'</span>, <span class="st">'bio5'</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Returned ReducedImageStack object</span>
<span class="va">bios_reduce</span>
<span class="co">#&gt; Dimension reduction</span>
<span class="co">#&gt; Correlation threshold: 0.6</span>
<span class="co">#&gt; Original variables: bio1, bio2, bio3, bio4, bio5, bio6, bio7, bio8, bio9,</span>
<span class="co">#&gt; bio10, bio11, bio12, bio13, bio14, bio15, bio16, bio17, bio18, bio19</span>
<span class="co">#&gt; Variables after dimension reduction: bio1, bio12, bio9, bio14, bio15</span>
<span class="co">#&gt; ================================================================================</span>
<span class="co">#&gt; Reduced correlations:</span>
<span class="co">#&gt;        bio1 bio12  bio9 bio14 bio15</span>
<span class="co">#&gt; bio1   1.00 -0.04  0.50 -0.07  0.44</span>
<span class="co">#&gt; bio12 -0.04  1.00 -0.03  0.56 -0.16</span>
<span class="co">#&gt; bio9   0.50 -0.03  1.00  0.01 -0.06</span>
<span class="co">#&gt; bio14 -0.07  0.56  0.01  1.00 -0.40</span>
<span class="co">#&gt; bio15  0.44 -0.16 -0.06 -0.40  1.00</span>

<span class="co"># img_reduced of ReducedImageStack is the raster stack</span>
<span class="va">bios_reduce</span><span class="op">$</span><span class="va">img_reduced</span>
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;                Min.  1st Qu.   Median     Mean  3rd Qu. Max.   NA's</span>
<span class="co">#&gt; reduced_image     0 17.75392 25.91388 154.5419 83.09974 4347 447385</span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from   to offset     delta refsys point         values x/y</span>
<span class="co">#&gt; x     975 1388   -180  0.166667 WGS 84 FALSE           NULL [x]</span>
<span class="co">#&gt; y     316  750     90 -0.166667 WGS 84 FALSE           NULL [y]</span>
<span class="co">#&gt; band    1    5     NA        NA     NA    NA bio1,...,bio15</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-the-virtual-species">Creating the virtual species<a class="anchor" aria-label="anchor" href="#creating-the-virtual-species"></a>
</h2>
<p>Using virtual species is a crucial method in ecological studies. First, let’s create a virtual species using the package <code>virtualspecies</code> to know exactly what is happening.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span>, quietly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://borisleroy.com/virtualspecies" class="external-link">virtualspecies</a></span>, quietly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="co"># Subset environmental variables to use</span>
<span class="va">bios_sub</span> <span class="op">&lt;-</span> <span class="va">bios</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="st">'band'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">12</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span>
<span class="va">bios_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/stack.html" class="external-link">stack</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/coerce-methods.html" class="external-link">as</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/merge.html" class="external-link">split</a></span><span class="op">(</span><span class="va">bios_sub</span><span class="op">)</span>, <span class="st">'Spatial'</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Formatting of the response functions</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">my.parameters</span> <span class="op">&lt;-</span> <span class="fu">formatFunctions</span><span class="op">(</span>
  bio1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">'dnorm'</span>, mean <span class="op">=</span> <span class="fl">25</span>, sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,
  bio5 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">'dnorm'</span>, mean <span class="op">=</span> <span class="fl">35</span>, sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,
  bio12 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">'dnorm'</span>, mean <span class="op">=</span> <span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>,
  bio15 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">'dnorm'</span>, mean <span class="op">=</span> <span class="fl">100</span>, sd <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Generation of the virtual species</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">my.species</span> <span class="op">&lt;-</span> <span class="fu">generateSpFromFun</span><span class="op">(</span>
  raster.stack <span class="op">=</span> <span class="va">bios_sub</span>,
  parameters <span class="op">=</span> <span class="va">my.parameters</span>,
  plot <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co"># Conversion to presence-absence</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">my.species</span> <span class="op">&lt;-</span> <span class="fu">convertToPA</span><span class="op">(</span>
  <span class="va">my.species</span>,
  beta <span class="op">=</span> <span class="fl">0.7</span>,
  plot <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>

<span class="co"># Check maps of this virtual species if you like</span>
<span class="co"># plot(my.species)</span>

<span class="co"># Check response curves</span>
<span class="fu">plotResponse</span><span class="op">(</span><span class="va">my.species</span><span class="op">)</span></code></pre></div>
<p><img src="intro-virtualspecies-1.png" title="plot of chunk virtualspecies" alt="plot of chunk virtualspecies" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="generate-pseudo-samples-for-virtual-species">Generate pseudo samples for virtual species<a class="anchor" aria-label="anchor" href="#generate-pseudo-samples-for-virtual-species"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Sampling</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="va">po.points</span> <span class="op">&lt;-</span> <span class="fu">sampleOccurrences</span><span class="op">(</span>
  <span class="va">my.species</span>,
  n <span class="op">=</span> <span class="fl">2000</span>,
  type <span class="op">=</span> <span class="st">"presence only"</span>,
  plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">po_df</span> <span class="op">&lt;-</span> <span class="va">po.points</span><span class="op">$</span><span class="va">sample.points</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">po_df</span><span class="op">)</span>
<span class="co">#&gt;           x          y id</span>
<span class="co">#&gt; 1 -6.083333  11.083333  1</span>
<span class="co">#&gt; 2 -5.750000  10.250000  2</span>
<span class="co">#&gt; 3 38.750000  -6.750000  3</span>
<span class="co">#&gt; 4 39.250000 -10.416667  4</span>
<span class="co">#&gt; 5 26.583333  -8.583333  5</span>
<span class="co">#&gt; 6  0.250000   9.083333  6</span></code></pre></div>
<p>As we all know, there are commonly sampling bias and observation errors. People use multiple methods to reduce these disturbances in samples. For example, here, we use the function <code>suspicious_env_outliers</code> to detect and/or remove possible environmental outliers. This step could be used with other strategies to do sample cleaning.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get environmental variable stack</span>
<span class="va">variables</span> <span class="op">&lt;-</span> <span class="va">bios</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="st">'band'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>,  <span class="fl">12</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Check outliers</span>
<span class="va">occ_outliers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/suspicious_env_outliers.html">suspicious_env_outliers</a></span><span class="op">(</span>
  <span class="va">po_df</span>,
  variables <span class="op">=</span> <span class="va">variables</span>,
  z_outlier <span class="op">=</span> <span class="fl">5</span>,
  outliers_print <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span>
<span class="co">#&gt; Reporting top 4 outliers [out of 6 found]</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; row [463] - suspicious column: [bio5] - suspicious value: [32.78]</span>
<span class="co">#&gt;  distribution: 95.714% &gt;= 36.01 - [mean: 37.68] - [sd: 0.66] - [norm. obs: 67]</span>
<span class="co">#&gt;  given:</span>
<span class="co">#&gt;      [bio1] &gt; [27.31] (value: 27.39)</span>
<span class="co">#&gt;      [bio15] &lt;= [102.79] (value: 102.48)</span>
<span class="co">#&gt;      [bio12] &lt;= [993.00] (value: 845.00)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; row [1346] - suspicious column: [bio5] - suspicious value: [32.96]</span>
<span class="co">#&gt;  distribution: 95.714% &gt;= 36.01 - [mean: 37.68] - [sd: 0.66] - [norm. obs: 67]</span>
<span class="co">#&gt;  given:</span>
<span class="co">#&gt;      [bio1] &gt; [27.31] (value: 27.41)</span>
<span class="co">#&gt;      [bio15] &lt;= [102.79] (value: 102.34)</span>
<span class="co">#&gt;      [bio12] &lt;= [993.00] (value: 855.00)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; row [1728] - suspicious column: [bio5] - suspicious value: [33.42]</span>
<span class="co">#&gt;  distribution: 95.714% &gt;= 36.01 - [mean: 37.68] - [sd: 0.66] - [norm. obs: 67]</span>
<span class="co">#&gt;  given:</span>
<span class="co">#&gt;      [bio1] &gt; [27.31] (value: 27.44)</span>
<span class="co">#&gt;      [bio15] &lt;= [102.79] (value: 66.08)</span>
<span class="co">#&gt;      [bio12] &lt;= [993.00] (value: 958.00)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; row [821] - suspicious column: [bio5] - suspicious value: [31.90]</span>
<span class="co">#&gt;  distribution: 98.333% &gt;= 34.51 - [mean: 36.25] - [sd: 0.84] - [norm. obs: 59]</span>
<span class="co">#&gt;  given:</span>
<span class="co">#&gt;      [bio1] between (24.12, 25.70] (value: 24.70)</span>
<span class="co">#&gt;      [bio15] &gt; [113.08] (value: 128.18)</span>
<span class="co">#&gt;      [bio12] &lt;= [996.00] (value: 658.00)</span>

<span class="co"># Check result</span>
<span class="co"># You could also plot samples overlap with a raster</span>
<span class="co"># plot(occ_outliers,</span>
<span class="co">#      overlay_raster = variables %&gt;% slice('band', 6))</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">occ_outliers</span><span class="op">)</span></code></pre></div>
<p><img src="intro-remove_outliers-1.png" title="plot of chunk remove_outliers" alt="plot of chunk remove_outliers" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Remove outliers if necessary</span>
<span class="va">occ_outliers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/suspicious_env_outliers.html">suspicious_env_outliers</a></span><span class="op">(</span>
  <span class="va">po_df</span>, variables <span class="op">=</span> <span class="va">variables</span>,
  rm_outliers <span class="op">=</span> <span class="cn">T</span>,
  z_outlier <span class="op">=</span> <span class="fl">5</span>,
  outliers_print <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span>
<span class="va">po_sf</span> <span class="op">&lt;-</span> <span class="va">occ_outliers</span><span class="op">$</span><span class="va">pts_occ</span>

<span class="co"># Make occurrences</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span>
<span class="va">occ_sf</span> <span class="op">&lt;-</span> <span class="va">po_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_frac</a></span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span>
<span class="va">occ_test_sf</span> <span class="op">&lt;-</span> <span class="va">po_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">occ_sf</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>
<span class="va">occ_sf</span> <span class="op">&lt;-</span> <span class="va">occ_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span><span class="op">)</span>
<span class="va">occ_test_sf</span> <span class="op">&lt;-</span> <span class="va">occ_test_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span><span class="op">)</span>

<span class="co"># Have a look at the samples if you like</span>
<span class="co"># ggplot() +</span>
<span class="co">#   geom_raster(data = as.data.frame(my.species$suitab.raster, xy = T),</span>
<span class="co">#               aes(x, y, fill = layer)) +</span>
<span class="co">#   scale_fill_viridis_c('Suitability', na.value = 'transparent') +</span>
<span class="co">#   geom_sf(data = occ_sf, aes(color = 'Train'), size = 0.8) +</span>
<span class="co">#   geom_sf(data = occ_test_sf, aes(color = 'Test'), size = 0.8) +</span>
<span class="co">#   scale_color_manual('', values = c('Train' = 'red', 'Test' = 'blue')) +</span>
<span class="co">#   theme_classic()</span>

<span class="co"># Recheck the variable correlation</span>
<span class="fu"><a href="../reference/dim_reduce.html">dim_reduce</a></span><span class="op">(</span><span class="va">variables</span>, threshold <span class="op">=</span> <span class="fl">1.0</span>, samples <span class="op">=</span> <span class="va">occ_sf</span><span class="op">)</span>
<span class="co">#&gt; Dimension reduction</span>
<span class="co">#&gt; Correlation threshold: 1</span>
<span class="co">#&gt; Original variables: bio1, bio5, bio12, bio15</span>
<span class="co">#&gt; Variables after dimension reduction: bio1, bio5, bio12, bio15</span>
<span class="co">#&gt; ================================================================================</span>
<span class="co">#&gt; Reduced correlations:</span>
<span class="co">#&gt;        bio1  bio5 bio12 bio15</span>
<span class="co">#&gt; bio1   1.00  0.69  0.19 -0.22</span>
<span class="co">#&gt; bio5   0.69  1.00 -0.03  0.20</span>
<span class="co">#&gt; bio12  0.19 -0.03  1.00 -0.37</span>
<span class="co">#&gt; bio15 -0.22  0.20 -0.37  1.00</span></code></pre></div>
<p>Unfortunately, bio1 and bio5 have strong correlation with each other. This might affect the model explanation later.</p>
</div>
<div class="section level2">
<h2 id="build-a-simple-isolation_forest-species-distribution-model">Build a simple <code>isolation_forest</code> species distribution model<a class="anchor" aria-label="anchor" href="#build-a-simple-isolation_forest-species-distribution-model"></a>
</h2>
<p>Here we build a SDM using extended isolation forest (with <code>ndim = 2</code>) and a sample rate of 0.8.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Do modeling</span>
<span class="va">it_sdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/isotree_po.html">isotree_po</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_sf</span>,
                     occ_test <span class="op">=</span> <span class="va">occ_test_sf</span>,
                     variables <span class="op">=</span> <span class="va">variables</span>,
                     sample_rate <span class="op">=</span> <span class="fl">0.8</span>,
                     ndim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>Let’s compare the predicted suitability with real suitability.</p>
<p><img src="intro-prediction-1.png" title="plot of chunk prediction" alt="plot of chunk prediction" style="display: block; margin: auto;"></p>
<p><img src="intro-raw_suit-1.png" title="plot of chunk raw_suit" alt="plot of chunk raw_suit" style="display: block; margin: auto;"></p>
<p>Let’s do model evaluation using multiple presence-only metrics. In this package, we implement both presence-only and presence-background evaluation metrics. The model calculated evaluation on both training and test datasets. Here we just display evaluation on test dataset. You could check <code>it_sdm$eval_train</code> the same way as <code>it_sdm$eval_test</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Metrics based on test dataset</span>
<span class="va">it_sdm</span><span class="op">$</span><span class="va">eval_test</span>
<span class="co">#&gt; ===================================</span>
<span class="co">#&gt; Presence-only evaluation:</span>
<span class="co">#&gt; CVI with 0.25 threshold:      0.614</span>
<span class="co">#&gt; CVI with 0.5 threshold:       0.810</span>
<span class="co">#&gt; CVI with 0.75 threshold:      0.693</span>
<span class="co">#&gt; CBI:                          0.998</span>
<span class="co">#&gt; AUC (ratio)                   0.942</span>
<span class="co">#&gt; ===================================</span>
<span class="co">#&gt; Presence-background evaluation:</span>
<span class="co">#&gt; Sensitivity:                  0.973</span>
<span class="co">#&gt; Specificity:                  0.870</span>
<span class="co">#&gt; TSS:                          0.843</span>
<span class="co">#&gt; AUC:                          0.946</span>
<span class="co">#&gt; Similarity indices:</span>
<span class="co">#&gt; Jaccard's similarity index:   0.861</span>
<span class="co">#&gt; Sørensen's similarity index:  0.925</span>
<span class="co">#&gt; Overprediction rate:          0.118</span>
<span class="co">#&gt; Underprediction rate:         0.027</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">it_sdm</span><span class="op">$</span><span class="va">eval_test</span><span class="op">)</span></code></pre></div>
<p><img src="intro-evaluation-1.png" title="plot of chunk evaluation" alt="plot of chunk evaluation" style="display: block; margin: auto;"></p>
<p>The result of <code>isotree_po</code> has options to generate response curves and variable analysis together. The response curves include marginal response curves, independent response curves, and Shapley value-based dependence. The variable analysis consists of the Jackknife of Pearson correlation with the result of the full model with all variables and AUC_ratio and variable dependence with SHAP test.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Plot response curves</span>
<span class="co">## Marginal response curves of bio5 and bio6</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">it_sdm</span><span class="op">$</span><span class="va">marginal_responses</span>, target_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'bio1'</span>, <span class="st">'bio5'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="intro-marginal_responses-1.png" title="plot of chunk marginal_responses" alt="plot of chunk marginal_responses" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Independent response curves of variable bio1 and bio12.</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">it_sdm</span><span class="op">$</span><span class="va">independent_responses</span>, target_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'bio1'</span>, <span class="st">'bio12'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="intro-independent_responses-1.png" title="plot of chunk independent_responses" alt="plot of chunk independent_responses" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Variable dependence scatter points with fitted curves made by SHAP test</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">it_sdm</span><span class="op">$</span><span class="va">shap_dependence</span>, smooth_span <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p><img src="intro-variable_dependence-1.png" title="plot of chunk variable_dependence" alt="plot of chunk variable_dependence" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Printing variable analysis could give you enough info of variable importance</span>
<span class="va">it_sdm</span><span class="op">$</span><span class="va">variable_analysis</span>
<span class="co">#&gt; Relative variable importance</span>
<span class="co">#&gt; ===================================</span>
<span class="co">#&gt; Methods: Jackknife test and SHAP</span>
<span class="co">#&gt; Numer of variables: 4</span>
<span class="co">#&gt; ===================================</span>
<span class="co">#&gt; Jackknife test</span>
<span class="co">#&gt; Based on Pearson correlation (Max value is 1)</span>
<span class="co">#&gt; [Training dataset]:</span>
<span class="co">#&gt; bio12 With only: ####################################### 0.875</span>
<span class="co">#&gt;       Without  : ########################################## 0.941</span>
<span class="co">#&gt; bio15 With only: ############################### 0.696</span>
<span class="co">#&gt;       Without  : ############################################ 0.972</span>
<span class="co">#&gt; bio5  With only: ############################### 0.687</span>
<span class="co">#&gt;       Without  : ############################################ 0.983</span>
<span class="co">#&gt; bio1  With only: ######################### 0.564</span>
<span class="co">#&gt;       Without  : ############################################ 0.978</span>
<span class="co">#&gt; [Test dataset]:</span>
<span class="co">#&gt; bio12 With only: ####################################### 0.866</span>
<span class="co">#&gt;       Without  : ########################################## 0.937</span>
<span class="co">#&gt; bio5  With only: ################################ 0.704</span>
<span class="co">#&gt;       Without  : ############################################ 0.983</span>
<span class="co">#&gt; bio15 With only: ############################### 0.69</span>
<span class="co">#&gt;       Without  : ############################################ 0.974</span>
<span class="co">#&gt; bio1  With only: ######################### 0.555</span>
<span class="co">#&gt;       Without  : ############################################ 0.979</span>
<span class="co">#&gt; ======================================================================</span>
<span class="co">#&gt; Jackknife test</span>
<span class="co">#&gt; Based on AUC ratio (Max value of traing and test are 0.946 and 0.942)</span>
<span class="co">#&gt; [Training dataset]:</span>
<span class="co">#&gt; bio12 With only: ######################################## 0.898</span>
<span class="co">#&gt;       Without  : ######################################### 0.922</span>
<span class="co">#&gt; bio5  With only: ##################################### 0.82</span>
<span class="co">#&gt;       Without  : ########################################## 0.94</span>
<span class="co">#&gt; bio15 With only: #################################### 0.8</span>
<span class="co">#&gt;       Without  : ########################################## 0.94</span>
<span class="co">#&gt; bio1  With only: ################################## 0.761</span>
<span class="co">#&gt;       Without  : ########################################## 0.942</span>
<span class="co">#&gt; [Test dataset]:</span>
<span class="co">#&gt; bio12 With only: ######################################## 0.878</span>
<span class="co">#&gt;       Without  : ######################################### 0.919</span>
<span class="co">#&gt; bio5  With only: #################################### 0.793</span>
<span class="co">#&gt;       Without  : ########################################## 0.936</span>
<span class="co">#&gt; bio15 With only: ################################### 0.774</span>
<span class="co">#&gt;       Without  : ########################################## 0.936</span>
<span class="co">#&gt; bio1  With only: ################################# 0.735</span>
<span class="co">#&gt;       Without  : ########################################## 0.937</span>
<span class="co">#&gt; ======================================================================</span>
<span class="co">#&gt; SHAP (mean(|Shapley value|))</span>
<span class="co">#&gt; [Training dataset]:</span>
<span class="co">#&gt; bio12 : ############################################ 0.054</span>
<span class="co">#&gt; bio15 : ########################## 0.032</span>
<span class="co">#&gt; bio5  : ######################### 0.031</span>
<span class="co">#&gt; bio1  : ###################### 0.026</span>
<span class="co">#&gt; [Test dataset]:</span>
<span class="co">#&gt; bio12 : ############################################# 0.055</span>
<span class="co">#&gt; bio15 : ########################## 0.032</span>
<span class="co">#&gt; bio5  : ########################## 0.032</span>
<span class="co">#&gt; bio1  : ##################### 0.026</span>

<span class="co"># We also could plot variable importance out</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">it_sdm</span><span class="op">$</span><span class="va">variable_analysis</span><span class="op">)</span></code></pre></div>
<p><img src="intro-variable_analysis-1.png" title="plot of chunk variable_analysis" alt="plot of chunk variable_analysis" style="display: block; margin: auto;"></p>
<p>According to the analysis, all explanatory variables contribute significantly to the model. This is predictable because the virtual species is made by these four variables. bio12 is the most important variable.</p>
<p>Besides the regular response curves, <code>itsdm</code> also makes spatially partial dependence maps. By default in <code>isotree_po</code>, Shapley value-based spatial dependence maps are not generated because of the computational efficiency. The user could generate these maps by calling function <code>spatial_response</code> later after getting the model done.</p>
<p>Note that a very large raster stack of environmental variables might cause memory failure or super slow computation when calculating Shapely value-based spatially dependence maps. So use it based on your own knowledge of your data. Shapley value-based dependence map will give you a bit more information of the value pushing the prediction higher or lower than average.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Generate spatially partial dependence maps including Shapley value-based one</span>
<span class="co">## Larger shap_nsim value could make smoother map but takes longer time as a</span>
<span class="co">## trade-off</span>
<span class="va">spatial_responses_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_response.html">spatial_response</a></span><span class="op">(</span>
  model <span class="op">=</span> <span class="va">it_sdm</span><span class="op">$</span><span class="va">model</span>,
  var_occ <span class="op">=</span> <span class="va">it_sdm</span><span class="op">$</span><span class="va">var_train</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span>,
  variables <span class="op">=</span> <span class="va">it_sdm</span><span class="op">$</span><span class="va">variables</span>,
  shap_nsim <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>

<span class="co"># Plot spatial response maps</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">spatial_responses_all</span>, target_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'bio1'</span>, <span class="st">'bio12'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="intro-spatial_response-1.png" alt=""><p class="caption">plot of chunk spatial_response</p>
</div>
<p>Marginal and independent effects only indicate the difference comparing the variable itself. And Shapley value based effect additionally show the relative contribution of one variable comparing to to other variables. For example, SHAP-based effect of bio1 shows that bio1 does not contribute much to the model over some areas even though it is an decisive variable.</p>
<p>The direct result of function <code>isotree_po</code> is environmental suitability. We could use function <code>convert_to_pa</code> to convert suitability to presence-absence based on different methods: threshold, logistic, and linear conversion, and/or a desirable species prevalence.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># An example of converting to presence-absence map</span>
<span class="co">## Use logistic conversion with alpha = -0.05, beta = 0.5</span>
<span class="co">## and not set species prevalence</span>
<span class="va">pa_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/convert_to_pa.html">convert_to_pa</a></span><span class="op">(</span><span class="va">it_sdm</span><span class="op">$</span><span class="va">prediction</span>,
                        method <span class="op">=</span> <span class="st">"logistic"</span>,
                        beta <span class="op">=</span> <span class="fl">0.7</span>, <span class="co"># the same with virtual species</span>
                        alpha <span class="op">=</span> <span class="op">-</span><span class="fl">.05</span><span class="op">)</span>
<span class="va">pa_map</span>; <span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pa_map</span><span class="op">)</span>
<span class="co">#&gt; Logistic conversion</span>
<span class="co">#&gt; beta = 0.7</span>
<span class="co">#&gt; alpha = -0.05</span>
<span class="co">#&gt; species prevalence = 0.105415337755068</span></code></pre></div>
<p><img src="intro-pa-1.png" title="plot of chunk pa" alt="plot of chunk pa" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="analyze-vairable-dependence">Analyze vairable dependence<a class="anchor" aria-label="anchor" href="#analyze-vairable-dependence"></a>
</h2>
<p>It is always helpful to understand the dependence among variables. The result of function <code>shap_dependence</code> or <code>it_sdm$shap_dependence</code> can be used to analyze variable dependence with each other.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">var_dependence</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shap_dependence.html">shap_dependence</a></span><span class="op">(</span>
  <span class="va">it_sdm</span><span class="op">$</span><span class="va">model</span>,
  <span class="va">it_sdm</span><span class="op">$</span><span class="va">var_train</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Multiple ways to plot variable VariableDependence object</span>
<span class="co">## Plot without smooth fit curve</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_dependence</span>,
     target_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'bio1'</span>, <span class="st">'bio12'</span><span class="op">)</span>,
     related_var <span class="op">=</span> <span class="st">'bio5'</span>, smooth_span <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p><img src="intro-var_inter_dependence-1.png" title="plot of chunk var_inter_dependence" alt="plot of chunk var_inter_dependence" style="display: block; margin: auto;"></p>
<p>Above figure shows bio1 and bio5 have strong correlations.</p>
</div>
<div class="section level2">
<h2 id="analyze-variable-contribution">Analyze variable contribution<a class="anchor" aria-label="anchor" href="#analyze-variable-contribution"></a>
</h2>
<p>Sometimes, we are interested in some observations, for instance, the outliers. <code>variable_contrib</code> is such function that allows you to analyze the contribution of each variable. It relies on Shapley values.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Analyze variable contribution for interested observations.</span>
<span class="co">## For example, outliers.</span>
<span class="va">var_contrib</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_contrib.html">variable_contrib</a></span><span class="op">(</span>
  <span class="va">it_sdm</span><span class="op">$</span><span class="va">model</span>,
  <span class="va">it_sdm</span><span class="op">$</span><span class="va">var_train</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span>,
  <span class="va">it_sdm</span><span class="op">$</span><span class="va">var_test</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Plot contribution separately for each observation</span>
<span class="co">## By default, it only plot the most 5 important variables for each observation</span>
<span class="co">## You could change `num_features` to show more variables</span>
<span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_contrib</span>, plot_each_obs <span class="op">=</span> <span class="cn">T</span>, num_features <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<p><img src="intro-var_contrib-1.png" title="plot of chunk var_contrib" alt="plot of chunk var_contrib" style="display: block; margin: auto;"></p>
<p>For example, No.2 observation is decided largely by bio15 and bio5 negatively. Let’s check it with spatial response map together.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html" class="external-link">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">spatial_responses_all</span><span class="op">$</span><span class="va">spatial_shap_dependence</span><span class="op">$</span><span class="va">bio15</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span><span class="st">'SHAP-based effect'</span>, palette <span class="op">=</span> <span class="st">"RdYlBu"</span>,
                       na.value <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">it_sdm</span><span class="op">$</span><span class="va">var_test</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, 
          color <span class="op">=</span> <span class="st">'blue'</span>, pch <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="intro-var_contrib_plot-1.png" title="plot of chunk var_contrib_plot" alt="plot of chunk var_contrib_plot" style="display: block; margin: auto;"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Lei Song.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
